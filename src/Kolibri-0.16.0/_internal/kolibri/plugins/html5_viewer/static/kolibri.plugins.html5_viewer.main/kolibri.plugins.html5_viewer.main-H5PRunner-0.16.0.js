/*! For license information please see kolibri.plugins.html5_viewer.main-H5PRunner-0.16.0.js.LICENSE.txt */
"use strict";(self["webpackChunkwebpack__kolibriplugins.html5_viewer.main"]=self["webpackChunkwebpack__kolibriplugins.html5_viewer.main"]||[]).push([[346],{4802:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:function(){return H5PRunner},replacePaths:function(){return replacePaths}});var get=__webpack_require__(468),get_default=__webpack_require__.n(get),isFunction=__webpack_require__(8946),isFunction_default=__webpack_require__.n(isFunction),pick=__webpack_require__(3573),pick_default=__webpack_require__.n(pick),set=__webpack_require__(4529),set_default=__webpack_require__.n(set),debounce=__webpack_require__(6115),debounce_default=__webpack_require__.n(debounce),unset=__webpack_require__(353),unset_default=__webpack_require__.n(unset),toposort_class=__webpack_require__(3960),toposort_class_default=__webpack_require__.n(toposort_class),browser=__webpack_require__(6755),h5p_build_namespaceObject=JSON.parse('{"v":"h5p-741035c0caad0682ab29b77f4c592a20.html"}'),mimetypes_namespaceObject=JSON.parse('{"js":"application/javascript","json":"application/json","doc":"application/msword","pdf":"application/pdf","rtf":"text/rtf","xls":"application/vnd.ms-excel","ppt":"application/vnd.ms-powerpoint","odp":"application/vnd.oasis.opendocument.presentation","ods":"application/vnd.oasis.opendocument.spreadsheet","odt":"application/vnd.oasis.opendocument.text","pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation","xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","swf":"application/x-shockwave-flash","xml":"text/xml","mp3":"audio/mpeg","m4a":"audio/x-m4a","ogg":"audio/ogg","wav":"audio/x-wav","otf":"font/otf","ttf":"font/ttf","woff":"font/woff","bmp":"image/x-ms-bmp","gif":"image/gif","jpeg":"image/jpeg","jpg":"image/jpeg","png":"image/png","svg":"image/svg+xml","tif":"image/tiff","tiff":"image/tiff","css":"text/css","csv":"text/csv","md":"text/markdown","txt":"text/plain","vtt":"text/vtt","mp4":"video/mp4","webm":"video/webm"}'),xAPIVocabulary=__webpack_require__(2449);function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _defineProperty(obj,key,value){return(key=_toPropertyKey(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(arr,i)||_unsupportedIterableToArray(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _toPropertyKey(t){var i=function(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==_typeof(i)?i:String(i)}for(var H5PFilename=h5p_build_namespaceObject.v,logging=console,Zip=function(){function Zip(file){_classCallCheck(this,Zip),this.zipfile=file}return _createClass(Zip,[{key:"_getFiles",value:function(filter){var _this=this;return new Promise((function(resolve,reject){(0,browser.Ri)(_this.zipfile,{filter:filter},(function(err,unzipped){err&&reject(err),resolve(Object.entries(unzipped).map((function(_ref){var _ref2=_slicedToArray(_ref,2);return{name:_ref2[0],obj:_ref2[1]}})))}))}))}},{key:"file",value:function(filename){return this._getFiles((function(file){return file.name===filename})).then((function(files){return files[0]}))}},{key:"files",value:function(path){return this._getFiles((function(file){return file.name.startsWith(path)}))}}]),Zip}(),doNotLogVerbMap={},_i=0,_doNotLogVerbs=["downloaded","copied","accessed-reuse","accessed-embed","accessed-copyright"];_i<_doNotLogVerbs.length;_i++){var doNotLogVerb=_doNotLogVerbs[_i];doNotLogVerbMap[xAPIVocabulary.K[doNotLogVerb]]=!0}for(var debounceVerbs=["answered","interacted"],completionVerbMap={},_i2=0,_completionVerbs=["completed","mastered","passed"];_i2<_completionVerbs.length;_i2++){var completionVerb=_completionVerbs[_i2];completionVerbMap[xAPIVocabulary.K[completionVerb]]=!0}function createBlobUrl(uint8array,fileName){var type="",fileNameExt=fileName.split(".").slice(-1)[0];if(fileNameExt){var ext=fileNameExt.toLowerCase();type=mimetypes_namespaceObject[ext]}var blob=new Blob([uint8array.buffer],{type:type});return URL.createObjectURL(blob)}var cssPathRegex=/(url\(['"]?)([^"')]+)?(['"]?\))/g;function replacePaths(dep,packageFiles){return packageFiles[dep].replace(cssPathRegex,(function(match,p1,p2,p3){try{var path=new URL(p2,new URL(dep,"http://b.b/")).pathname.substring(1),newUrl=packageFiles[path];if(newUrl)return"".concat(p1).concat(newUrl).concat(p3)}catch(e){logging.debug("Error during URL handling",e)}return match}))}var metadataKeys=["title","a11yTitle","authors","changes","source","license","licenseVersion","licenseExtras","authorComments","yearFrom","yearTo","defaultLanguage"],H5PRunner=function(){function H5PRunner(shim){_classCallCheck(this,H5PRunner),this.shim=shim,this.data=shim.data,this.scriptLoader=this.scriptLoader.bind(this)}return _createClass(H5PRunner,[{key:"init",value:function(iframe,filepath,loaded,errored){var _this2=this;this.dependencies=[],this.jsDependencies={},this.cssDependencies={},this.packageFiles={},this.contentPaths={},this.contentJson="",this.library=null,this.loadedJs={},this.loadedCss={},this.iframe=iframe,this.iframe.src="../h5p/".concat(H5PFilename),this.filepath=filepath,this.zipcontentUrl=new URL("../../zipcontent/".concat(this.filepath.substring(this.filepath.lastIndexOf("/")+1)),window.location).href,this.loaded=loaded,this.errored=errored,this.contentNamespace="1234567890";var path,start=performance.now();(path=this.filepath,new Promise((function(resolve,reject){try{var xhr=new window.XMLHttpRequest;xhr.open("GET",path,!0),xhr.responseType="arraybuffer",xhr.onreadystatechange=function(){if(4===xhr.readyState)if(200===xhr.status||0===xhr.status)try{resolve(new Uint8Array(xhr.response))}catch(err){reject(new Error(err))}else reject(new Error("Ajax error for "+path+" : "+xhr.status+" "+xhr.statusText))},xhr.send()}catch(e){reject(new Error(e),null)}}))).then((function(file){return _this2.zip=new Zip(file),_this2.recurseDependencies("h5p.json",!0)})).then((function(){return _this2.setDependencies(),_this2.processFiles().then((function(){if(logging.debug("H5P file processed in ".concat(performance.now()-start," ms")),_this2.metadata=pick_default()(_this2.rootConfig,metadataKeys),_this2.processCssDependencies(),_this2.processJsDependencies(),_this2.iframe.contentDocument&&"complete"===_this2.iframe.contentDocument.readyState&&_this2.iframe.contentWindow.H5P)return _this2.initH5P();_this2.iframe.addEventListener("load",(function(){return _this2.initH5P()}))}))}))}},{key:"stateUpdated",value:function(){this.shim.stateUpdated()}},{key:"initH5P",value:function(){var _this3=this;return this.shimH5P(this.iframe.contentWindow),this.scriptLoader(this.cssURL,!0).then((function(){return _this3.scriptLoader(_this3.javascriptURL).then((function(){try{_this3.iframe.contentWindow.H5P.init(),_this3.loaded(),setTimeout((function(){var _step,_iterator=_createForOfIteratorHelper(_this3.iframe.contentWindow.H5P.instances);try{for(_iterator.s();!(_step=_iterator.n()).done;){var instance=_step.value;_this3.iframe.contentWindow.H5P.trigger(instance,"resize")}}catch(err){_iterator.e(err)}finally{_iterator.f()}}),0)}catch(e){_this3.errored(e)}}))}))}},{key:"shimH5P",value:function(contentWindow){var div=contentWindow.document.createElement("div");div.classList.add("h5p-content"),div.setAttribute("data-content-id",this.contentNamespace),contentWindow.document.body.appendChild(div);var H5P=contentWindow.H5P,originalGetPath=H5P.getPath,self=this;H5P.getPath=function(path,contentId){return"#tmp"===path.substr(-4,4)&&(path=path.substr(0,path.length-4)),self.contentPaths[path]?self.contentPaths[path]:originalGetPath(path,contentId)},H5P.getContentPath=function(){return self.zipcontentUrl+"/content"},H5P.getUserData=function(contentId,dataId,done){var subContentId=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,data=get_default()(self.data,[subContentId,dataId]);return done(void 0,"RESET"===data?null:data)},H5P.setUserData=function(contentId,dataId,data){var _ref3=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},_ref3$subContentId=_ref3.subContentId,subContentId=void 0===_ref3$subContentId?0:_ref3$subContentId,_ref3$errorCallback=_ref3.errorCallback,errorCallback=void 0===_ref3$errorCallback?null:_ref3$errorCallback;try{data=JSON.stringify(data)}catch(err){return void(isFunction_default()(errorCallback)&&errorCallback(err))}set_default()(self.data,[subContentId,dataId],data),self.stateUpdated()},H5P.deleteUserData=function(contentId,dataId){var subContentId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;unset_default()(self.data,[subContentId,dataId]),self.stateUpdated()};var originalContentType=H5P.ContentType;H5P.ContentType=function(isRoot){var ct=originalContentType(isRoot);return ct.prototype.getLibraryFilePath=function(filePath){var url=self.packageFiles[this.libraryInfo.versionedNameNoSpaces+"/"][filePath];return url||self.zipcontentUrl+"/"+this.libraryInfo.versionedNameNoSpaces+"/"},ct},H5P.XAPIEvent.prototype.setActor=function(){contentWindow.xAPI&&contentWindow.xAPI.prepareStatement(this.data.statement)};for(var debouncedHandlers={},_i3=0,_debounceVerbs=debounceVerbs;_i3<_debounceVerbs.length;_i3++){var debouncedVerb=_debounceVerbs[_i3],verb=xAPIVocabulary.K[debouncedVerb];debouncedHandlers[verb]=debounce_default()((function(statement){contentWindow.xAPI.sendStatement(statement,!0).catch((function(err){logging.error("Statement: ",statement,"gave the following error: ",err)}))}),5e3,{leading:!0,maxWait:3e4})}H5P.externalDispatcher.on("xAPI",(function(event){if(contentWindow.xAPI){var statement=event.data.statement;if(statement.object&&statement.object.id.startsWith(self.H5PContentIdentifier)&&statement.object.id!==self.H5PContentIdentifier&&statement.verb&&completionVerbMap[statement.verb.id]&&(statement.verb.id=xAPIVocabulary.K.progressed),doNotLogVerbMap[statement.verb.id])return;debouncedHandlers[statement.verb.id]?debouncedHandlers[statement.verb.id](statement):contentWindow.xAPI.sendStatement(event.data.statement,!0).catch((function(err){logging.error("Statement: ",statement,"gave the following error: ",err)}))}}))}},{key:"H5PContentIdentifier",get:function(){return this.rootConfig&&this.rootConfig.source||"http://kolibri.to/content/".concat(this.contentNamespace)}},{key:"shimH5PIntegration",value:function(contentWindow){var self=this;this.integrationShim={get contents(){return _defineProperty({},(contentId=self.contentNamespace,"cid-".concat(contentId)),{library:self.library,jsonContent:self.contentJson,fullScreen:!1,displayOptions:{copyright:!1,download:!1,embed:!1,export:!1,frame:!1,icon:!1},contentUserData:self.data,exportUrl:"",embedCode:"",resizeCode:"",mainId:self.contentNamespace,url:self.H5PContentIdentifier,title:self.rootConfig.title,styles:Object.keys(self.loadedCss),scripts:Object.keys(self.loadedJs),metadata:self.metadata});var contentId},l10n:{H5P:{}},get loadedJs(){return Object.keys(self.loadedJs)},get loadedCss(){return Object.keys(self.loadedCss)},get user(){return{name:self.userData.userFullName,mail:""}},get urlLibraries(){return self.zipcontentUrl}},Object.defineProperty(contentWindow,"H5PIntegration",{value:this.integrationShim,configurable:!0})}},{key:"scriptLoader",value:function(url){var css=arguments.length>1&&void 0!==arguments[1]&&arguments[1],iframeDocument=this.iframe.contentWindow.document;return new Promise((function(resolve,reject){var script;css?((script=iframeDocument.createElement("link")).rel="stylesheet",script.type="text/css",script.href=url,resolve(script)):((script=iframeDocument.createElement("script")).type="text/javascript",script.src=url,script.async=!0,script.addEventListener("load",(function(){return resolve(script)})),script.addEventListener("error",reject)),iframeDocument.body.appendChild(script)}))}},{key:"setDependencies",value:function(){var _step2,dependencySorter=new(toposort_class_default()),_iterator2=_createForOfIteratorHelper(this.dependencies);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var dependency=_step2.value;this.packageFiles[dependency.packagePath]={},dependencySorter.add(dependency.packagePath,dependency.dependencies),this.cssDependencies[dependency.packagePath]=dependency.preloadedCss,this.jsDependencies[dependency.packagePath]=dependency.preloadedJs}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}this.sortedDependencies=dependencySorter.sort().reverse()}},{key:"recurseDependencies",value:function(jsonFile,root){var _this4=this,visitedPaths=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},packagePath=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return this.zip.file(jsonFile).then((function(file){if(file){var json=JSON.parse((0,browser.T8)(file.obj)),preloadedDependencies=json.preloadedDependencies||[];return visitedPaths=function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}({},visitedPaths),root&&(_this4.rootConfig=json),Promise.all(preloadedDependencies.map((function(dep){var depPackagePath="".concat(dep.machineName,"-").concat(dep.majorVersion,".").concat(dep.minorVersion,"/");return root&&!_this4.library&&dep.machineName===json.mainLibrary&&(_this4.library="".concat(dep.machineName," ").concat(dep.majorVersion,".").concat(dep.minorVersion)),visitedPaths[depPackagePath]?Promise.resolve(depPackagePath):(visitedPaths[depPackagePath]=!0,_this4.recurseDependencies(depPackagePath+"library.json",!1,visitedPaths,depPackagePath).then((function(){return depPackagePath})))}))).then((function(dependencies){if(packagePath){var preloadedJs=(json.preloadedJs||[]).map((function(js){return js.path})),preloadedCss=(json.preloadedCss||[]).map((function(css){return css.path}));_this4.dependencies.push({packagePath:packagePath,dependencies:dependencies,preloadedCss:preloadedCss,preloadedJs:preloadedJs})}}))}}))}},{key:"processJsDependencies",value:function(){var _this5=this,concatenatedJS=this.sortedDependencies.reduce((function(wholeJS,dependency){return(_this5.jsDependencies[dependency]||[]).reduce((function(allJs,jsDep){return"".concat(allJs).concat(_this5.packageFiles[dependency][jsDep],"\n\n")}),wholeJS)}),"");this.javascriptURL=URL.createObjectURL(new Blob([concatenatedJS],{type:"text/javascript"}))}},{key:"processCssDependencies",value:function(){var _this6=this,concatenatedCSS=this.sortedDependencies.reduce((function(wholeCSS,dependency){return(_this6.cssDependencies[dependency]||[]).reduce((function(allCss,cssDep){var css=replacePaths(cssDep,_this6.packageFiles[dependency]);return"".concat(allCss).concat(css,"\n\n")}),wholeCSS)}),"");this.cssURL=URL.createObjectURL(new Blob([concatenatedCSS],{type:"text/css"}))}},{key:"processContent",value:function(file){var fileName=file.name.replace("content/","");"content.json"===fileName?this.contentJson=(0,browser.T8)(file.obj):this.contentPaths[fileName]=createBlobUrl(file.obj,fileName)}},{key:"processPackageFile",value:function(file,packagePath){var fileName=file.name.replace(packagePath,""),jsFile=this.jsDependencies[packagePath].indexOf(fileName)>-1;this.cssDependencies[packagePath].indexOf(fileName)>-1||jsFile?(jsFile?this.loadedJs[file.name]=!0:this.loadedCss[file.name]=!0,this.packageFiles[packagePath][fileName]=(0,browser.T8)(file.obj)):this.packageFiles[packagePath][fileName]=createBlobUrl(file.obj,fileName)}},{key:"processFiles",value:function(){var _this7=this;return Promise.all([this.zip.files("content/").then((function(contentFiles){contentFiles.map((function(file){return _this7.processContent(file)}))}))].concat(_toConsumableArray(Object.keys(this.packageFiles).map((function(packagePath){return _this7.zip.files(packagePath).then((function(packageFiles){packageFiles.map((function(file){return _this7.processPackageFile(file,packagePath)}))}))})))))}}]),H5PRunner}()}}]);
//# sourceMappingURL=kolibri.plugins.html5_viewer.main-H5PRunner-0.16.0.js.map